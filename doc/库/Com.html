<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Com &mdash; SpinalHDL_Chinese 1.0.0 文档</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/translations.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="IO口" href="IO%E5%8F%A3.html" />
    <link rel="prev" title="总线(bus)" href="%E6%80%BB%E7%BA%BF.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> SpinalHDL_Chinese
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../%E5%85%B3%E4%BA%8ESpinalHDL/index.html">关于SpinalHDL(About SpinalHDL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../%E5%BC%80%E5%A7%8B%E5%85%A5%E9%97%A8/index.html">开始入门(Getting Started)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/index.html">数据类型(Data Types)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../%E7%BB%93%E6%9E%84/index.html">结构(Structuring)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../%E8%AF%AD%E4%B9%89/index.html">语义(Semantic)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../%E6%97%B6%E5%BA%8F%E9%80%BB%E8%BE%91/index.html">时序逻辑(Sequential logic)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../%E8%AE%BE%E8%AE%A1%E9%94%99%E8%AF%AF/index.html">设计错误(Design Errors)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../%E5%85%B6%E5%AE%83%E8%AF%AD%E8%A8%80%E7%89%B9%E5%BE%81/index.html">其他语言特征(Other language features)</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Libraries(库)</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="%E7%AE%80%E4%BB%8B.html">简介</a></li>
<li class="toctree-l2"><a class="reference internal" href="%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7.html">Utils(实用工具)</a></li>
<li class="toctree-l2"><a class="reference internal" href="%E6%B5%81%E5%BC%8F.html">流(Stream)</a></li>
<li class="toctree-l2"><a class="reference internal" href="%E6%B5%81.html">Flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="%E7%89%87%E6%AE%B5.html">片段(Fragment)</a></li>
<li class="toctree-l2"><a class="reference internal" href="%E7%8A%B6%E6%80%81%E6%9C%BA.html">状态机(State machine)</a></li>
<li class="toctree-l2"><a class="reference internal" href="VexRiscv.html">VexRiscv(RV32IM CPU)</a></li>
<li class="toctree-l2"><a class="reference internal" href="%E4%BB%8E%E7%AB%AF%E6%80%BB%E7%BA%BF%E5%BA%93.html">从端总线库(Bus Slave Factory)</a></li>
<li class="toctree-l2"><a class="reference internal" href="%E7%BA%A4%E7%A8%8B%E6%A1%86%E6%9E%B6.html">纤程框架(Fiber Framework)</a></li>
<li class="toctree-l2"><a class="reference internal" href="%E4%BA%8C%E8%BF%9B%E5%88%B6%E7%B3%BB%E7%BB%9F.html">二进制系统(Binary System)</a></li>
<li class="toctree-l2"><a class="reference internal" href="%E5%AF%84%E5%AD%98%E5%99%A8%E6%8E%A5%E5%8F%A3.html">寄存器接口(RegIf)</a></li>
<li class="toctree-l2"><a class="reference internal" href="%E4%B8%AD%E6%96%AD%E8%AE%BE%E8%AE%A1%E8%A7%84%E8%8C%83.html">中断设计规范(Interrupt Design Spec)</a></li>
<li class="toctree-l2"><a class="reference internal" href="%E6%80%BB%E7%BA%BF.html">总线(bus)</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Com</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#uart">一、UART</a></li>
<li class="toctree-l3"><a class="reference internal" href="#usb">二、USB设备</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="IO%E5%8F%A3.html">IO口</a></li>
<li class="toctree-l2"><a class="reference internal" href="%E5%9B%BE%E5%BD%A2.html">图形(Graphics)</a></li>
<li class="toctree-l2"><a class="reference internal" href="%E8%87%AA%E5%8A%A8%E8%AE%BE%E8%AE%A1%E5%B7%A5%E5%85%B7.html">自动设计工具(EDA)</a></li>
<li class="toctree-l2"><a class="reference internal" href="Misc.html">Misc</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../%E4%BB%BF%E7%9C%9F/index.html">仿真(Simulation)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../%E5%BD%A2%E5%BC%8F%E9%AA%8C%E8%AF%81/index.html">形式验证(Formal verification)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../%E4%BE%8B%E5%AD%90/index.html">例子(Examples)</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">SpinalHDL_Chinese</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Libraries(库)</a> &raquo;</li>
      <li>Com</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/doc/库/Com.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="com">
<h1>Com<a class="headerlink" href="#com" title="此标题的永久链接"></a></h1>
<section id="uart">
<h2>一、UART<a class="headerlink" href="#uart" title="此标题的永久链接"></a></h2>
<ol>
<li><p>简介</p>
<p>可以使用UART协议来发出和接收RS232 / RS485帧。</p>
<p>有一个没有奇偶校验并拥有一个停止位的8位帧的例子:</p>
<p><img alt="uart" src="../../_images/uart.png" /></p>
</li>
<li><p>总线定义</p>
<div class="highlight-Scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Uart</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">IMasterSlave</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">txd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"> </span><span class="c1">// Used to emit frames</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">rxd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"> </span><span class="c1">// Used to receive frames</span>

<span class="w">    </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">asMaster</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">out</span><span class="p">(</span><span class="n">txd</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">in</span><span class="p">(</span><span class="n">rxd</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>UartCtrl</p>
<p>库中实现了一个Uart控制器。这个控制器的特性是使用一个采样窗口来读取<code class="docutils literal notranslate"><span class="pre">rxd</span></code>引脚, 然后使用多数投票制来过滤它的值。</p>
<p>| IO口名 |  方向  |      类型      |                       描述                        |
| :—-: | :—-: | :————: | :———————————————–: |
| config |   in   | UartCtrlConfig | 用于设置控制器的时钟分频器/奇偶校验/停止/数据长度 |
| write  | slave  |  Stream[Bits]  |          用于请求进行帧交换传输的流端口           |
|  read  | master |   Flow[Bits]   |              用于接收解码帧的流端口               |
| write  | master |      Uart      |               与实际实现的连接接口                |</p>
<p>控制器可以通过一个<code class="docutils literal notranslate"><span class="pre">UartCtrlGenerics</span></code>配置对象实例化:</p>
</li>
</ol>
<table border="1" class="docutils">
<thead>
<tr>
<th style="text-align: center;">属性</th>
<th style="text-align: center;">类型</th>
<th style="text-align: center;">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">dataWidthMax</td>
<td style="text-align: center;">Int</td>
<td style="text-align: center;">帧内的最大位数</td>
</tr>
<tr>
<td style="text-align: center;">clockDividerWidth</td>
<td style="text-align: center;">Int</td>
<td style="text-align: center;">内部时钟分频器的位宽</td>
</tr>
<tr>
<td style="text-align: center;">preSamplingSize</td>
<td style="text-align: center;">Int</td>
<td style="text-align: center;">指定有多少samplingTick在一个UART波特的起始处下降</td>
</tr>
<tr>
<td style="text-align: center;">samplingSize</td>
<td style="text-align: center;">Int</td>
<td style="text-align: center;">指定有多少samplingTick用于采样UART波特中段的<code>rxd</code>值</td>
</tr>
<tr>
<td style="text-align: center;">postSamplingSize</td>
<td style="text-align: center;">Int</td>
<td style="text-align: center;">指定在一个UART波特值的末尾有多少个samplingTick被丢弃</td>
</tr>
</tbody>
</table></section>
<section id="usb">
<h2>二、USB设备<a class="headerlink" href="#usb" title="此标题的永久链接"></a></h2>
<ol>
<li><p>简介</p>
<p>SpinalHDL库中有一个USB设备控制器。在以下几个要点中, 它可以设置为:</p>
<ul class="simple">
<li><p>它允许CPU配置和管理端点</p></li>
<li><p>存储端点状态和事务描述符的内部RAM</p></li>
<li><p>多达16个端点(几乎没有额外开销)</p></li>
<li><p>支持USB主机全速运行(12Mbps)</p></li>
<li><p>在linux上使用自己的驱动程序进行测试(https://github.com/SpinalHDL/linux/blob/dev/drivers/usb/gadget/udc/spinal_udc.c)</p></li>
<li><p>用于配置的Bmb内存接口</p></li>
<li><p>内部需要一个频率是12Mhz的倍数的时钟, 至少为48Mhz</p></li>
<li><p>控制器频率不受限制</p></li>
<li><p>不需要外部phy</p></li>
</ul>
<p>Linux小工具测试和功能:</p>
<ul class="simple">
<li><p>串行连接</p></li>
<li><p>以太网连接</p></li>
<li><p>大容量存储(在ArtyA7 linux上达到8mbps)</p></li>
</ul>
<p>部署：</p>
<ul class="simple">
<li><p>https://github.com/SpinalHDL/SaxonSoc/tree/dev-0.3/bsp/digilent/ArtyA7SmpLinux</p></li>
<li><p>https://github.com/SpinalHDL/SaxonSoc/tree/dev-0.3/bsp/radiona/ulx3s/smp</p></li>
</ul>
</li>
<li><p>架构(Architecture)</p>
<p>控制器由以下部分组成：</p>
<ul class="simple">
<li><p>少数控制寄存器</p></li>
<li><p>一个用来存储端点状态的内部RAM, 一个传输描述符合端点0配置数据。</p></li>
</ul>
<p>每个端点的描述符链表是为了处理USB的出入任务和数据。</p>
<p>端点0也会像其他端点一样处理出入USB的交换任务但也会有一些额外的硬件来处理SETUP(设置)任务：</p>
<ul class="simple">
<li><p>它的链表在每个设置任务上被清除</p></li>
<li><p>设置任务的数据存储在一个固定的位置(SETUP_DATA)</p></li>
<li><p>它对设置任务有一个特定的中断标志</p></li>
</ul>
</li>
<li><p>寄存器(Registers)</p>
<p>注意, 控制器的所有寄存器和内存只能以32位的字访问, 不支持字节访问。</p>
<ul class="simple">
<li><p>帧FRAME (0xFF00)</p></li>
</ul>
</li>
</ol>
<pre><code>  |    名称    | 类型  | 比特  |      描述       |
  | :--------: | :---: | :---: | :-------------: |
  | usbFrameId |  RO   | 31-0  | 目前的usb帧的id |
</code></pre><ul class="simple">
<li><p>地址ADDRESS (0xFF04)</p></li>
</ul>
<pre><code>  |  名称   | 类型  | 比特  |                                   描述                                    |
  | :-----: | :---: | :---: | :-----------------------------------------------------------------------: |
  | address |  WO   |  6-0  | 该USB设备只会被特定地址的令牌(token)所控制。其字段会被usb重置任务自动清除 |
  | enable  |  WO   |   8   |                         如果设置, 启用USB地址过滤                         |
  | trigger |  WO   |   9   |        设置下一个EP0 IN令牌使能(见上文)。在任何EP0完成后由硬件清除        |
</code></pre><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   这里的想法是保持整个寄存器清空, 直到EP0上接收到USB SET_ADDRESS设置包。此时, 用户可以设置地址和触发器字段, 然后向EP0提供IN零长度描述符, 以结束SET_ADDRESS序列。然后, 控制器将在描述符完成时自动打开地址过滤。
</pre></div>
</div>
<ul>
<li><p>中断INTERRUPT (0xFF08)</p>
<p>这个寄存器的所有位都可以通过写入“1”来清除。</p>
</li>
</ul>
<pre><code>  |    名称    | 类型  | 比特  |           描述            |
  | :--------: | :---: | :---: | :-----------------------: |
  | endpoints  |  RC   | 15-0  |   当端点产生中断时拉高    |
  |   reset    |  RC   |  16   |    当USB复位发生时拉高    |
  |  ep0Setup  |  RC   |  17   | 当端点0收到配置请求时拉高 |
  |  suspend   |  RC   |  18   |     当端点悬挂时拉高      |
  |   resume   |  RC   |  19   |     当端点恢复时拉高      |
  | disconnect |  RC   |  20   |   当端点连接中断时拉高    |
</code></pre><ul>
<li>Halt (0xFF0C)</li>
</ul><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   这个寄存器允许在休眠状态下放置一个端点, 以确保CPU操作的原子性, 允许对端点寄存器和描述符进行读/修改/写操作。如果给定的端点是由usb主机寻址的, 外围设备将返回NAK。
</pre></div>
</div>
<pre><code>  |       名称       | 类型  | 比特  |                          描述                          |
  | :--------------: | :---: | :---: | :----------------------------------------------------: |
  |    endpointId    |  WO   |  3-0  |                 用户想要休眠的目标端点                 |
  |      enable      |  WO   |   4   |                                                        |
  | effective enable |  RO   |   5   | 在设置了使能后, 需要等待硬件本身设置该位, 以确保原子性 |
</code></pre><ul class="simple">
<li><p>配置CONFIG (0xFF10)</p></li>
</ul>
<pre><code>  |         名称         | 类型  | 比特  |                 描述                 |
  | :------------------: | :---: | :---: | :----------------------------------: |
  |      pullupSet       |  SO   |   0   | 写入' 1 '来启用dp引脚上的USB设备上拉 |
  |     pullupClear      |  SO   |   1   |                                      |
  |  interruptEnableSet  |  SO   |   2   |    写“1”, 让现在和未来的中断发生     |
  | interruptEnableClear |  SO   |   3   |                                      |
</code></pre><ul class="simple">
<li><p>INFO (0xFF20)</p></li>
</ul>
<pre><code>  |  名称   | 类型  | 比特  |            描述            |
  | :-----: | :---: | :---: | :------------------------: |
  | ramSize |  RO   |  3-0  | 内部ram将有(1 &lt;&lt; this)字节 |
</code></pre><ul>
<li><p>端点 ENDPOINTS (0x0000 - 0x003F)</p>
<p>端点状态存储在内部ram的开头, 每个有32位字。</p>
</li>
</ul>
<pre><code>   |     名称      | 类型  | 比特  |                               描述                                |
   | :-----------: | :---: | :---: | :---------------------------------------------------------------: |
   |    enable     |  RW   |   0   |             若不设置, 则该端点忽略所有的流量(traffic)             |
   |     stall     |  RW   |   1   |                 若设置了, 端点将始终返回STALL状态                 |
   |     nack      |  RW   |   2   |                 若设置了, 端点将始终返回NACK状态                  |
   |   dataPhase   |  RW   |   3   |  指定使用的IO数据PID。' 0 ' = &gt; DATA0。这个字段也由控制器更新。   |
   |     head      |  RW   | 15-4  | 指定当前描述符头部(链表)0 =&gt; empty list, byte address = this &lt;&lt; 4 |
   |  isochronous  |  RW   |  16   | 指定当前描述符头部(链表)0 =&gt; empty list, byte address = this &lt;&lt; 4 |
   | maxPacketSize |  RW   | 31-22 |                                                                   |
</code></pre><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   为了获得一个端点响应需要：设置其使能标志位为1.

   还有其他一些例子:要么用户有停滞或纳标记集,因此,控制器总是有相应的响应；要么EP0设置请求,控制器不会使用描述符,但将数据写入SETUP_DATA寄存器和ACK；要么用户有一个空链表(head==0)并响应NACK；要么用户至少有一个描述符由头部指出,在这种情况下将执行和ACK。
</pre></div>
</div>
<ul class="simple">
<li><p>SETUP_DATA (0x0040 - 0x0047)</p></li>
<li></li>
<li><p>当端点0接收SETUP任务时, 该任务的数据将存储在该位置</p></li>
</ul>
<ol>
<li><p>描述符(Descriptors)</p>
<p>描述符允许指定端点需要如何处理IO传输任务的数据阶段。它们存储在内部ram中, 可以通过它们的链表链接在一起, 并且需要在16字节的边界上对齐.</p>
</li>
</ol>
<table border="1" class="docutils">
<thead>
<tr>
<th style="text-align: center;">名称</th>
<th style="text-align: center;">字</th>
<th style="text-align: center;">比特</th>
<th style="text-align: center;">述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">offset</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">15-0</td>
<td style="text-align: center;">指定当前传输进度(以字节为位)</td>
</tr>
<tr>
<td style="text-align: center;">code</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">19-16</td>
<td style="text-align: center;">0xF =&gt; in progress, 0x0 =&gt;success</td>
</tr>
<tr>
<td style="text-align: center;">next</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">15-4</td>
<td style="text-align: center;">指定下一个传输符 0 =&gt; nothing, byte address = this &lt;&lt;4</td>
</tr>
<tr>
<td style="text-align: center;">length</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">31-16</td>
<td style="text-align: center;">为数据字段分配的字数</td>
</tr>
<tr>
<td style="text-align: center;">direction</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">16</td>
<td style="text-align: center;">‘0’ =&gt; OUT, ‘1’ =&gt;IN</td>
</tr>
<tr>
<td style="text-align: center;">interrupt</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">17</td>
<td style="text-align: center;">如果设置了, 则描述符的完成将生成一个断。</td>
</tr>
<tr>
<td style="text-align: center;">completionOnFull</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">18</td>
<td style="text-align: center;">通常, 描述符补全只发生在USB传输小于maxPacketSize时。但是如果设置了这个字段, 那么当描述符被填满时也被认为事件已完成(抵消= =长度)</td>
</tr>
<tr>
<td style="text-align: center;">data1OnCompletion</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">19</td>
<td style="text-align: center;">强制端点dataphaseDATA1</td>
</tr>
<tr>
<td style="text-align: center;">data</td>
<td style="text-align: center;">...</td>
<td style="text-align: center;">...</td>
<td style="text-align: center;"></td>
</tr>
</tbody>
</table><p>注意, 如果控制器接收到一个帧, 其中IO不匹配描述符IO, 该帧将被忽略。</p>
<p>另外, 要初始化描述符, CPU应该将代码字段设置为0xF.</p>
<ol>
<li><p>使用(usage)</p>
<div class="highlight-Scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">sim</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">bus</span><span class="p">.</span><span class="nn">bmb</span><span class="p">.</span><span class="nc">BmbParameter</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">com</span><span class="p">.</span><span class="nn">usb</span><span class="p">.</span><span class="nn">phy</span><span class="p">.</span><span class="nc">UsbDevicePhyNative</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">com</span><span class="p">.</span><span class="nn">usb</span><span class="p">.</span><span class="nn">sim</span><span class="p">.</span><span class="nc">UsbLsFsPhyAbstractIoAgent</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">com</span><span class="p">.</span><span class="nn">usb</span><span class="p">.</span><span class="nn">udc</span><span class="p">.{</span><span class="nc">UsbDeviceCtrl</span><span class="p">,</span><span class="w"> </span><span class="nc">UsbDeviceCtrlParameter</span><span class="p">}</span>


<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">UsbDeviceTop</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">ctrlCd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">external</span><span class="p">(</span><span class="s">&quot;ctrlCd&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">frequency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">FixedFrequency</span><span class="p">(</span><span class="mi">100</span><span class="w"> </span><span class="nc">MHz</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">phyCd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">external</span><span class="p">(</span><span class="s">&quot;phyCd&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">frequency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">FixedFrequency</span><span class="p">(</span><span class="mi">48</span><span class="w"> </span><span class="nc">MHz</span><span class="p">))</span><span class="w"></span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">ctrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctrlCd</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">UsbDeviceCtrl</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UsbDeviceCtrlParameter</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">addressWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">14</span><span class="w"></span>
<span class="w">        </span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">bmbParameter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">BmbParameter</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">addressWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UsbDeviceCtrl</span><span class="p">.</span><span class="n">ctrlAddressWidth</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">dataWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">sourceWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">contextWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">lengthWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">phy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phyCd</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">UsbDevicePhyNative</span><span class="p">(</span><span class="n">sim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"></span>
<span class="n">ctrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">cc</span><span class="p">(</span><span class="n">ctrlCd</span><span class="p">,</span><span class="w"> </span><span class="n">phyCd</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">phy</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">ctrl</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">bmb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">toIo</span><span class="p">()</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">usb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phy</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">usb</span><span class="p">.</span><span class="n">toIo</span><span class="p">()</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">power</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phy</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">toIo</span><span class="p">()</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">pullup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phy</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">pullup</span><span class="p">.</span><span class="n">toIo</span><span class="p">()</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">interrupts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">interrupt</span><span class="p">.</span><span class="n">toIo</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>


<span class="k">object</span><span class="w"> </span><span class="nc">UsbDeviceGen</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">App</span><span class="p">{</span><span class="w"></span>
<span class="nc">SpinalVerilog</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">UsbDeviceTop</span><span class="p">())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="%E6%80%BB%E7%BA%BF.html" class="btn btn-neutral float-left" title="总线(bus)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="IO%E5%8F%A3.html" class="btn btn-neutral float-right" title="IO口" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, THU-CGRA.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>